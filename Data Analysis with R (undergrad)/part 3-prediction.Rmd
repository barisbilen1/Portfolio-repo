---
title: "part3"
author: "Case study - Ali Baris Bilen"
date: "3/28/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#PART 3

```{r}
library(magrittr)
library(tidyverse)
library(knitr)
library(pander)
library(modelr)
library(readr)
library(data.table)
```

```{r}
d_training <- read_csv("training.csv")
d_test <- read_csv("test.csv")

d_training <- d_training %>% mutate(ProductType =factor(ProductType), Promotion =factor(Promotion), StoreType = factor(StoreType))
d_test <- d_test %>% mutate(ProductType =factor(ProductType), Promotion =factor(Promotion), StoreType = factor(StoreType))

d_training_withoutdates <- d_training %>% select(-Date)     #effect plots do not work if there is date
d_test_withoutdates <- d_test %>% select(-Date)
```

```{r}
linmod14 <- lm(SalesQuantity_x ~. + ProductType:StoreType + ProductType:Promotion, data= d_training)
linmod14_withoutdates <- lm(SalesQuantity_x ~. + ProductType:StoreType + ProductType:Promotion, data= d_training_withoutdates)  #constructing the model I have decided in part 2.
```

```{r}
library(effects)
#Effect(c("Promotion","StoreType"), mod = linmod14_withoutdates, partial.residuals = TRUE) %>% plot()
```
```{r}
d_training %>%  
	group_by(Promotion) %>%
	summarise(average_sales_of_product = mean(SalesQuantity_x))
```

To answer part f in the first question I use t-test.

```{r}
sales_with_promotion <- d_training %>% filter(Promotion == "PromotionSales")
sales_without_promotion <- d_training %>% filter(Promotion == "NoPromotion")

sales_with_promotion_slow_products <- sales_with_promotion %>% filter(ProductType == "SlowProduct")
sales_with_promotion_slow_products_values <- sales_with_promotion_slow_products$SalesQuantity_x

sales_without_promotion_slow_products <- sales_without_promotion %>% filter(ProductType == "SlowProduct")
sales_without_promotion_slow_products_values  <- sales_without_promotion_slow_products$SalesQuantity_x

difference_slow_products <- (sales_with_promotion_slow_products_values) - (sales_without_promotion_slow_products_values)

#####################

sales_with_promotion_fast_products <- sales_with_promotion %>% filter(ProductType == "FastProduct")
sales_with_promotion_fast_products_values <- sales_with_promotion_fast_products$SalesQuantity_x

sales_without_promotion_fast_products <- sales_without_promotion %>% filter(ProductType == "FastProduct")
sales_without_promotion_fast_products_values  <- sales_without_promotion_fast_products$SalesQuantity_x

difference_fast_products <- (sales_with_promotion_fast_products_values) - (sales_without_promotion_fast_products_values)

####################

t.test(difference_slow_products, y = difference_fast_products,
       alternative = "t",
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)
```
Clearly there is difference between promotion impacts of the FastProducts vs. SlowProducts.


To answer part g in the first question I use t-test again.

```{r}
sales_with_promotion_slow_stores <- sales_with_promotion %>% filter(StoreType == "SlowStore")
sales_with_promotion_slow_stores_values <- sales_with_promotion_slow_stores$SalesQuantity_x

sales_without_promotion_slow_stores <- sales_without_promotion %>% filter(StoreType == "SlowStore")
sales_without_promotion_slow_stores_values  <- sales_without_promotion_slow_stores$SalesQuantity_x

difference_slow_stores <- (sales_with_promotion_slow_stores_values) - (sales_without_promotion_slow_stores_values)

#####################

sales_with_promotion_fast_stores <- sales_with_promotion %>% filter(StoreType == "FastStore")
sales_with_promotion_fast_stores_values <- sales_with_promotion_fast_stores$SalesQuantity_x

sales_without_promotion_fast_stores <- sales_without_promotion %>% filter(StoreType == "FastStore")
sales_without_promotion_fast_stores_values  <- sales_without_promotion_fast_stores$SalesQuantity_x

difference_fast_stores <- (sales_with_promotion_fast_stores_values) - (sales_without_promotion_fast_stores_values)

####################

t.test(difference_slow_stores, y = difference_fast_stores,
       alternative = "t",
       mu = 0, paired = FALSE, var.equal = FALSE,
       conf.level = 0.95)
```

```{r}
plot(d_training$StoreType,d_training$SalesQuantity_x)
```

```{r}
linmod14 %>% summary()
```
RSE/mean calculation:

```{r}
residualse <- summary(linmod14)$sigma
avg_rse <- ((residualse)/mean(d_training$SalesQuantity_x))
print(avg_rse)
```

Lastly I will calculate test MSE using the test set (slicing the portion that falls into the period of promotion5);


```{r}
d_test_promo5 <- d_test %>% filter(d_test$Date >= "2015-09-01" & d_test$Date <= "2015-09-06")
d_test_promo5 %>% tail()
```

```{r}
pred <- predict(linmod14,d_test_promo5) #prediction
test_mse=mean((d_test$SalesQuantity_x-pred)^2) #calculating MSE 
test_mse
```

Comparison of forecast values and real observed sales:

```{r}
comparison <- tibble( 'Forecast' = pred, 'RealSales' = d_test_promo5$SalesQuantity_x)
comparison
```

Let us transform them back to original scale.

```{r}
comparison_original_scale <- comparison %>% mutate(Forecast = (((Forecast)^(3))-1), RealSales = (RealSales^3)-1)
comparison_original_scale
```


should round them.

```{r}
comparison_original_scale$Forecast <- round(comparison_original_scale$Forecast,digits=3)
comparison_original_scale$RealSales<- round(comparison_original_scale$RealSales,digits=3)
```

```{r}
comparison_original_scale
```



```{r}
d_training_2 <- d_training %>% group_by(Date) %>% 
	summarise(average_sales= mean(SalesQuantity_x))
```
```{r}
d_training_3 <- d_training_2 %>% select(-Date)
```


```{r}

```

```{r}
(time_plot <- ggplot(d_training_2, aes(x = Date, y = average_sales)) +
	geom_line() +
	scale_x_date(date_labels = "%W", date_breaks = "1 week") +
	theme_classic())
```


```{r}
 (decomp_2 <- ggplot(d_training_2, aes(x = Date, y = average_sales)) +
 	geom_line() +
 	geom_smooth(method = "loess", se = FALSE, span = 0.6) +
    theme_classic())
```
















































