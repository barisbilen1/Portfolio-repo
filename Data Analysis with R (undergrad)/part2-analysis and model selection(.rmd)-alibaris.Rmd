---
title: "part 2"
author: "Case study - Ali Baris Bilen"
date: "3/27/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r} 
#importing libraries
library(magrittr)
library(tidyverse)
library(knitr)
library(pander)
library(modelr)
library(readr)
library(data.table)
```

```{r}
data <- read_csv("d7.csv")
```

```{r}
data <- data %>% rename(StoreType = StoreCode , ProductType = ProductCode)
```

```{r}
data <- data %>% mutate(StoreType = factor(StoreType), ProductType = factor(ProductType))
```

```{r}
data %>% summary()
```

The reason why there are 6263 stores encoded as 31's is that I made a small mistake when separating the categories. 
In the rmd file named "invent-alibaris-part1" (will be referred to as part 1), when setting the boundary between slow and medium stores, I use 1.8714 as a bound for a slow store.
So, the interval should have started from 1.8715 for medium stores, however I accidently set it as 1.875. It turns out that indeed there is a store with average sales per store value between
1.8714 and 1.875. This mistake caused 31's to stay as they are and no category was assigned to them." I am pretty sure this is the case because I checked the rest of the code and found nothing improper. 
That's why I am going to encode 31's as *Medium*s. (I will later change them to Medium"Stores", Fast"Stores" just like the products)

```{r}
data$StoreType[data$StoreType == "31"] <- "Medium"
```

```{r}
data <- data %>% mutate(StoreType = factor(StoreType), ProductType = factor(ProductType))     #just to get rid of 31, otherwise it still shows it as one of the levels.
data %>% summary()
```

```{r}
data$StoreType <- as.character(data$StoreType)
#temporarily making them characters
data$StoreType[data$StoreType == "Fast"] <- "FastStore"
data$StoreType[data$StoreType == "Medium"] <- "MediumStore"
data$StoreType[data$StoreType == "Slow"] <- "SlowStore"

data$StoreType <- as.factor(data$StoreType)   #converting them to factor back.
```

```{r}
data %>% head()
```


```{r}
data <- data %>% mutate(Promotion = factor(Promotion))
data %>% summary()
```

Now the data makes much more sense and ready to be used for analysis.

#Exploration

Before model construction and further analysis, I will check for the correlations between variables, histograms, distributions, diagnostic plots and anomalies.

```{r}
library(corrplot)

panel.hist <- function(x, ...)
{
    usr <- par("usr"); on.exit(par(usr))
    par(usr = c(usr[1:2], 0, 1.5) )
    h <- hist(x, plot = FALSE)
    breaks <- h$breaks; nB <- length(breaks)
    y <- h$counts; y <- y/max(y)
    rect(breaks[-nB], 0, breaks[-1], y, col = "cyan", ...)
}

panel.cor <- function(x, y, digits = 2, prefix = "", cex.cor, ...)
{
    usr <- par("usr"); on.exit(par(usr))
    par(usr = c(0, 1, 0, 1))
    r <- abs(cor(x, y))
    txt <- format(c(r, 0.123456789), digits = digits)[1]
    txt <- paste0(prefix, txt)
    if(missing(cex.cor)) cex.cor <- 0.8/strwidth(txt)
    text(0.5, 0.5, txt, cex = cex.cor * r)
}

```


```{r}
#pairs(data, diag.panel = panel.hist, upper.panel = panel.smooth, lower.panel = panel.cor)
```

Unfortunately, above set of plots do not tell us anything. I want to check the histogram of *SalesQuantity*.

```{r}
hist(data$SalesQuantity)
```

We see that its distribution is extremely right-skewed. This is not surprising because it generally takes values between 0 and 3, and it  must stay between 0 and 264 (max of *SalesQuantity*).

```{r}
 data2 <- data %>% mutate(SalesQuantity_log = log1p(SalesQuantity)) %>%
 select(-SalesQuantity) %>%
 relocate(SalesQuantity_log)

hist(data2$SalesQuantity_log)                         # this did not fix the issue.
```

```{r}
# d3 <- data %>% mutate(SalesQuantity_croot = (SalesQuantity)^(1/3)) %>%
#     select(-SalesQuantity) %>%
#     relocate(SalesQuantity_croot)
# hist(d3$SalesQuantity_croot) 
```


```{r}
#applying box-cox to log-transformed SalesQuantity (gave poor results)

# bc_power <- car::powerTransform(SalesQuantity_log ~ ., family = "bcPower", data=data2)$lambda %>% unname()
# 
# data_bc <- data2 %>% 
#   mutate(SalesQuantity_bc = sign(bc_power)*(SalesQuantity_log^bc_power))  %>% 
#   select(-SalesQuantity_log) %>% 
#   relocate(SalesQuantity_bc)
```


```{r, fig.asp=1}
# d_linreg <- data %>% 
#   mutate(SalesQuantity_x = log(SalesQuantity/(100-SalesQuantity))) %>% 
#   select(-SalesQuantity) %>% 
#   relocate(SalesQuantity_x)
# 
# hist(d_linreg$SalesQuantity_x)
# 
# bc_power <- car::powerTransform(SalesQuantity ~ ., family = "bcPower", data=data)$lambda %>% unname()
# 
# d_bc <- d %>% 
#   mutate(sales_bc = sign(bc_power)*SalesQuantity_x^bc_power)  %>% 
#   select(-SalesQuantity_x) %>% 
#   relocate(sales_bc)
# 
# d_bc %>% 
#   pairs(., diag.panel = panel.hist, upper.panel = panel.smooth, lower.panel = panel.cor, main = "Box-Cox Transformation")

```

<!-- ```{r, error=TRUE} -->
<!-- bcn_power <- car::powerTransform(logitP ~ ., family = "bcnPower", data=d_linreg) -->
<!-- ``` -->


```{r}
# d2 <- data %>% 
#   mutate(SalesQuantity = log(SalesQuantity/(100-SalesQuantity))) %>% 
#   select(-SalesQuantity) %>% 
#   relocate(logitP)
# 
# bc_power <- car::powerTransform(P ~ ., family = "bcPower", data=d)$lambda %>% unname()
# 
# d_bc <- d %>% 
#   mutate(bcP = sign(bc_power)*P^bc_power)  %>% 
#   select(-P) %>% 
#   relocate(bcP)
# 

```

I tried everything to normalize SalesQuantity but could not manage it. I will apply the following transformation (it is still terrible but seems slightly better than the raw data). 

```{r}
d3 <- data %>% mutate(SalesQuantity_x = (SalesQuantity+1)^(1/3)) %>%
     select(-SalesQuantity) %>%
    relocate(SalesQuantity_x)

hist(d3$SalesQuantity_x)

```

We will continue with d3.

```{r}
d4 <- d3 %>% select(-Date)     
d4 %>% summary()
d4 %>% head()
```

```{r}
d4 %>%  
	group_by(ProductType) %>%
	summarise(average_sales_of_product = mean(SalesQuantity_x))
```


Our job is to find which one of them increased its sales in the presence of a promotion.

```{r}
linmod1 <- lm(SalesQuantity_x ~ . , data = d4)
```

```{r}
#linmod <- MASS::rlm(SalesQuantity_x ~ . , data = d4)
```

```{r}
# library(sfsmisc)
# f.robftest(linmod, var = "StoreTypeMediumStore")
```

I tried to fit a robust linear regression using rlm() from MASS package but it is not compatible with some useful techniques which I want to apply it to regression to improve it (such as step()).
Also it does not show the p-values of the predictors in its summary, you have to look at them one by one, which is very impractical.

I will continue with the plain linear regression model.

```{r}
linmod1 %>% summary()
```
 
We see that all variables are significant at a significance level of 0.05. But the R^2 value is very low. We need to improve the model.

```{r}
library(effects) 
#allEffects(linmod1, partial.residuals = TRUE) %>% plot()      #I commented some of the codes because I don't want to repeat them when I restart the session. I extracted the visuals and will present them in the report.
```


And as expected, fast (both stores and products) have higher SalesQuantity than the other two, and medium is higher than slow.
It is just nice to see the consistency.

```{r}
Effect(c("StoreType", "ProductType"), mod = linmod1, partial.residuals = TRUE) %>% plot()
```


I see that *FastProduct*s possess somewhat a synergy with *FastStore*s. I want to add an interaction term between stores and products.

```{r}
update(linmod1, . ~ . +ProductType:StoreType) %>% summary()
```
There is certainly a relation of that sort but R-square value did not increase much. Let us go without the interaction term.

```{r}
Effect(c( "ProductType","Promotion"), mod = linmod1, partial.residuals = TRUE) %>% plot()
```


I observe that *FastProduct*s' reaction to promotions is more than those of the other two. One can observe that promotions even reduced the sales of *SlowProduct*s, did not affect much the sales of *MediumStore*s.
Nevertheless, effect plots are not enough to draw this conclusion.

```{r}
#plot(linmod1)
```

I observe from the Normal Q-Q plot that the below four observations apply strong force to the regression line and disrupt normality. I remove them.

```{r}
d4 <- d4[-990421,]
d4 <- d4[-390772,]
d4 <- d4[-989731,]
d4 <- d4[-159934,]
```

```{r}
linmod3 <- lm(SalesQuantity_x ~ ., data=d4)    #re-fitting linear regression
summary(linmod3)
```

Sadly, R-square did not improve.

I just want to apply one-hot encoding to categorical variables to check for the correlation between them (as cor() function expects numeric values).

```{r}
library(caret)
d4.1 <- d4
dmy <- dummyVars( ~ ., data = d4.1)
trsf <- data.frame(predict(dmy, newdata = d4.1))
trsf
```

```{r}
cor(trsf)
```

```{r}
#this chunk takes too much time, I stopped it.
# trsf %>% 
#   select_if(is.numeric) %>% 
#   pairs(diag.panel = panel.hist, 
#         upper.panel = function(...) panel.smooth(..., lwd=2, col="yellow"), 
#         lower.panel = panel.cor)
```

I check box-plots.

```{r}
# d4 %>% 
#         ggplot(aes(ProductType,SalesQuantity_x)) +
#         geom_boxplot()
```
Not much to say about the above box-plot. As expected, fast has higher sales.

```{r}
# d4 %>% 
#         ggplot(aes(StoreType,SalesQuantity_x)) +
#         geom_boxplot()
```


I see that, especially between *MediumStore* and *SlowStore*, there is not much difference among different store types in terms of average sales.

```{r}
# d4 %>% 
#         ggplot(aes(Promotion,SalesQuantity_x)) +
#         geom_boxplot()
```


It is quite strange that promotions seem to have no effect on sales.

Still continuing exploratory data analysis; (I will go into details of linear model later)

```{r}
# library(ggplot2)
# d4 %>%
# ggplot(aes(SalesQuantity,ProductType)) +
# geom_point(col="gray") +
# geom_density_2d()
```

```{r}
# trsf %>%
# select_if(is.numeric) %>%
# cor(use = "pairwise.complete.obs") %>%
# corrplot(type = "lower", diag = FALSE, order = "hclust")
```


```{r} 
# linmod.trial <- lm(SalesQuantity_x ~ ., data=trsf)      #I want to look at the effect plots of one-hot encoded data.
# Effect(c("StoreType", "ProductType"), mod = linmod1, partial.residuals = TRUE) %>% plot()
```

No difference as I expected, just wanted to confirm.

```{r}
linmod1 %>% step()
```



Under this section, I will try to convert StoreType and ProductType to numeric values of 1,2,3 and check what happens. As there is an ordinal relationship between classes, this makes sense to me.

```{r}
d4.2 <- d4

# ordered <- factor(colors, levels = rainbow)
# as.numeric(ordered)

encode_ordinal1 <- function(x, order = unique(x)) {
  x <- as.numeric(factor(x,  exclude = NULL))
  x
}

table(d4.2[["StoreType"]], encode_ordinal1(d4.2[["StoreType"]]), useNA = "ifany")

table(d4.2[["StoreType"]],
      encode_ordinal1(d4.2[["StoreType"]], order = c(NA,"HighStore", "MediumStore", "SlowStore")),
      useNA = "ifany")

table(d4.2[["StoreType"]],
      encode_ordinal1(d4.2[["StoreType"]], order = c( "HighStore", "MediumStore","SlowStore" ,NA)),
      useNA = "ifany")

d4.3 <- d4.2
d4.3[["Store_encoded"]] <- encode_ordinal1(d4.2[["StoreType"]])

d4.3 %>% head(20)

```

```{r}
d4.4 <- d4.3 %>% select(-StoreType)
d4.4 %>% head(20)
```


```{r}
write.csv(d4,"C:\\users\\asus\\Desktop\\d4_part2_salestransformed.csv", row.names = FALSE) #just backing up in case I need it
```

Let's do the same for products.

```{r}
table(d4.4[["ProductType"]], encode_ordinal1(d4.4[["ProductType"]]), useNA = "ifany")

table(d4.4[["ProductType"]],
      encode_ordinal1(d4.4[["ProductType"]], order = c(NA,"HighProduct", "MediumProduct", "SlowProduct")),
      useNA = "ifany")

table(d4.4[["ProductType"]],
      encode_ordinal1(d4.4[["ProductType"]], order = c( "HighProduct", "MediumProduct","SlowProduct" ,NA)),
      useNA = "ifany")
d4.5 <- d4.4
d4.5[["Product_encoded"]] <- encode_ordinal1(d4.4[["ProductType"]])

d4.5

d4.5 <- d4.5 %>% select(-ProductType)
```

```{r}
d4.6 <- d4.5 %>%  relocate(Promotion) %>% relocate(Product_encoded) %>% relocate(Store_encoded) %>% relocate(SalesQuantity_x)
```

```{r}
d4.6 %>% tail(2000)
d4.6 <- d4.6 %>% mutate(Promotion = as.character(Promotion))
d4.6[d4.6$Promotion == "Promo1", "Promotion"] <- "PromotionSales"  
d4.6[d4.6$Promotion == "Promo2", "Promotion"] <- "PromotionSales"  
d4.6[d4.6$Promotion == "Promo3", "Promotion"] <- "PromotionSales"  
d4.6[d4.6$Promotion == "Promo4", "Promotion"] <- "PromotionSales"  
```

```{r}
d9_with_numbers <- d4.6
write.csv(d9_with_numbers,"C:\\users\\asus\\Desktop\\d9_with_numbers.csv", row.names = FALSE)
```


Let's fit a new regression model to this data and see what happens.

```{r}
linmod_encoded <- lm(SalesQuantity_x ~ . , d4.6)
```

```{r}
linmod_encoded %>% summary()
```
Unfortunately, it got worse. R-square value decreased by 1% (it was 12.xx % before).

```{r}
#linmod_encoded %>% step()              #step() function suggests us to include all variables as predictors in our model.
```


```{r}
linmod2 <- lm(SalesQuantity_x ~. + StoreType:ProductType + I(ProductType,2), d4)
```

```{r}
linmod1 %>% summary()
```
Performing best subset selection:

```{r}
library(leaps)
library(glmnet)
best_subset_selection <- regsubsets(SalesQuantity_x~.,d4,nvmax=10)
```

```{r}
summary(best_subset_selection)$cp %>% which.min()
summary(best_subset_selection)$bic %>% which.min() 
summary(best_subset_selection)$adjr2 %>% which.max() 
summary(best_subset_selection)
```

All three metrics suggest 8 variable model.

```{r}
d3 <- d3 %>% relocate(Date)
```

```{r}
# tsdata <- ts(d3[,1:2],frequency=7)
# p <- ggplot(d3, aes(x=Date, y=SalesQuantity_x)) +
#   geom_line() + 
#   xlab("")
# #p
# #p+scale_x_date(date_labels = "%W")
# p + scale_x_date(date_breaks = "1 week", date_labels = "%W")
# library(plotly)
# library(TSstudio)
# ts_info(tsdata)
```

```{r}
library(glmnet)

X <- model.matrix(SalesQuantity_x ~ ., d3)[ ,-2]
y <- d3$SalesQuantity_x

lasso2 <- cv.glmnet(X,y,alpha=1,nfolds=10) #finding lambda with cross validation, k=10
lasso2$lambda.min
lasso.fit2 <- glmnet(X,y,alpha=1,lambda=lasso2$lambda.min)
#plot(lasso2)
coef(lasso.fit2)
```

Lasso proposes 8-variable (all included) model as well.

```{r}
predlasso2 <- predict(lasso.fit2,X)
test.mse.with.lasso2 <- mean((y-predlasso2)^2)
test.mse.with.lasso2
```
Test MSE is 15%.

```{r}
#plot(d3$Date, d3$SalesQuantity_x)
```


```{r}
write.csv(d3,"C:\\users\\asus\\Desktop\\part2_final_with_dates.csv", row.names = FALSE)
```

```{r}
d3 <- d3 %>% mutate(Promotion = as.character(Promotion))
```


A MAJOR CHANGE IN THE DATA:

Up to now, I was thinking that Promo1,..,Promo4 are different promotions, possibly with different discount rates, etc. Now I read the part B of assignment 4, and saw that this was not the case. 
I am changing promo1,...,promo4 as only "Promotion". From now, there will be only two values in Promotion column, one is *Promotion* and the other one is *NoPromotion*.

Unfortunately I will need to repeat some of the things I have done above for the new data.

At the moment, I have 48 hours to complete the assignment. If you remember, in part 1, assignment of StoreTypes to each StoreCode and same for the products took 12-13 hours in total.
To do same on assignment4.1b (new test data) I will need more or less 10 hours but I don't have that much time. I am going to change them on Excel, by filtering each StoreCode and ProductCode and looking at the list (containing Store and Product Codes for each category) and change them manually by hand. Then I will import that data and evaluate my performance.

First, let's fix the promotion/nopromotion issue.

```{r}
d9 <- read_csv("part2_final_with_dates.csv")
```

```{r}
d9 %>% head()  #this is exatcly the same as d3, but I had to refresh it because that above for loop had damaged it.
```

Let's check if this works.

```{r}
d9[d9$Promotion == "Promo1", "Promotion"] <- "PromotionSales"  
```

```{r}
d9 %>% mutate(Promotion = factor(Promotion)) %>% summary()
```



```{r}
d9[d9$Promotion == "Promo2", "Promotion"] <- "PromotionSales" 
d9[d9$Promotion == "Promo3", "Promotion"] <- "PromotionSales" 
d9[d9$Promotion == "Promo4", "Promotion"] <- "PromotionSales" 
```

```{r}
d9 %>% mutate(Promotion = factor(Promotion)) %>% summary()
```

```{r}
d9 <- d9 %>% mutate(Promotion = factor(Promotion),StoreType = factor(StoreType), ProductType = factor(ProductType))
```

```{r}
d9 %>% summary()
```


```{r}
d9.1 <- d9 %>% select(-Date)
linmod1 <- lm(SalesQuantity_x ~ ., data=d9)
summary(linmod1)
```

```{r}
linmod1 %>% step()
```


step() function again suggests us to include all of the variables. (here, faststore and fastproduct have been chosen as base levels when encoding)


I am just backing up one more time.

```{r}
write.csv(d9,"C:\\users\\asus\\Desktop\\final_part2_promfixed.csv", row.names = FALSE)
```

Now I will repeat the things I have done before.

```{r}
library(effects) 
d9.2 <- d9 %>% select(-Date)
linmod4 <- lm(SalesQuantity_x ~ ., data=d9.2)
allEffects(linmod4, partial.residuals = TRUE) %>% plot()
```



```{r}
Effect(c("StoreType", "ProductType"), mod = linmod4, partial.residuals = TRUE) %>% plot()
```

I see that *FastProduct*s possess somewhat a synergy with *FastStore*s. I want to add an interaction term between stores and products.

```{r}
update(linmod4, . ~ . +ProductType:StoreType) %>% summary()
```

There is certainly a relation of that sort but R-square value did not increase much. Normally, I wouldn't prefer adding this term to the model because it will incur me additional variance at the expense of only 0.40% improvement in R-square value. However, since my model is not very good, I am taking this risk and adding the interaction term to my model for the moment being.

```{r}
linmod4 <- update(linmod4, . ~ . +ProductType:StoreType)
```

Let's also look at effect plot of *ProductType* vs. *Promotion*.

```{r}
Effect(c( "ProductType","Promotion"), mod = linmod4, partial.residuals = TRUE) %>% plot()
```
I observe that *FastProduct*s' reaction to promotions is more than those of the other two. One can observe that promotions even reduced the sales of *SlowProduct*s.
Nevertheless, effect plots are not enough to draw this conclusion. We should investigate further.

```{r}
Effect(c( "StoreType","Promotion"), mod = linmod4, partial.residuals = TRUE) %>% plot()
```


```{r}
plot(linmod4)
```

I observe from the Normal Q-Q plot (and also other ones) that some of the observations apply force to the regression line and disrupt normality. I remove them.

```{r}
d9.2  <- d9.2 [-990421,]
d9.2  <- d9.2 [-390772,]
d9.2  <- d9.2 [-989731,]
d9.2  <- d9.2 [-1599340,]
```

```{r}
linmod5 <- lm(SalesQuantity_x ~ . + StoreType:ProductType, data=d9.2)    #re-fitting linear regression
summary(linmod5)
```

Unfortunately no improvement.


I just want to apply one-hot encoding to categorical variables to check for the correlation between them (as cor() function expects numeric values).

```{r}
library(caret)
d9.3 <- d9.2
dmy <- dummyVars( ~ ., data = d4.3)
trsf <- data.frame(predict(dmy, newdata = d4.3))
trsf
```

```{r}
cor(trsf)
```

```{r}
# aov1 = aov(SalesQuantity_x ~ ProductType, data=d9.3)
# summary(aov1)
```

```{r}
# chisq.test(d9[,3:5])
```
Performing best subset selection:

```{r}
library(leaps)
library(glmnet)
best_subset_selection <- regsubsets(SalesQuantity_x~.,d9,nvmax=10,method='forward')
best_subset_selection %>% summary
```

Forward selection also suggests that all variables should be included in the model. It is so hard to find a room for improvement.
I am stuck.

```{r}
table(d4.2[["StoreType"]], encode_ordinal1(d4.2[["StoreType"]]), useNA = "ifany")

table(d4.2[["StoreType"]],
      encode_ordinal1(d4.2[["StoreType"]], order = c(NA,"HighStore", "MediumStore", "SlowStore")),
      useNA = "ifany")

table(d4.2[["StoreType"]],
      encode_ordinal1(d4.2[["StoreType"]], order = c( "HighStore", "MediumStore","SlowStore" ,NA)),
      useNA = "ifany")

d4.3 <- d4.2
d4.3[["Store_encoded"]] <- encode_ordinal1(d4.2[["StoreType"]])

d4.3 %>% head(20)
```
```{r}
table(d4.4[["ProductType"]], encode_ordinal1(d4.4[["ProductType"]]), useNA = "ifany")

table(d4.4[["ProductType"]],
      encode_ordinal1(d4.4[["ProductType"]], order = c(NA,"HighProduct", "MediumProduct", "SlowProduct")),
      useNA = "ifany")

table(d4.4[["ProductType"]],
      encode_ordinal1(d4.4[["ProductType"]], order = c( "HighProduct", "MediumProduct","SlowProduct" ,NA)),
      useNA = "ifany")
d4.5 <- d4.4
d4.5[["Product_encoded"]] <- encode_ordinal1(d4.4[["ProductType"]])

d4.5 <- d4.5 %>% select(-ProductType)
```

just trying a random forest regression and got 0.18 test mse.


```{r}
#Splitting the dataset into the Training set and Test set
library(caTools)
set.seed(41)
split = sample.split(d4.5$SalesQuantity_x, SplitRatio = 2/3)
training_set = subset(d4.5, split == TRUE)
test_set = subset(d4.5, split == FALSE)

#Feature Scaling
training_set = scale(training_set) #gives error saying that x must be numeric, but it is? (1,2,3) I couldn't figure out.
test_set = scale(test_set)

# Fitting Random Forest Regression to the dataset
library(randomForest)
set.seed(41)
regressor = randomForest(x = d4.5[-1],
                         y = d4.5$SalesQuantity_x,
                         ntree = 10)

# Predicting a new result with Random Forest Regression
y_pred = predict(regressor, test_set)

test.mse.3 <- mean((d4.5$SalesQuantity_x - y_pred)^2)
test.mse.3

```
I tried a random forest model and got 18% test mse.

```{r}
summary(linmod4)
```


```{r}
library(caret)
d9.4 <- d9.4
dmy <- dummyVars( ~ ., data = d9.4)
trsf2 <- data.frame(predict(dmy, newdata = d9.4))
```

```{r}
linmod6 <- lm(SalesQuantity_x ~ ., d9.4)
linmod6 %>% summary()
```

```{r}
d10 <- d3

table(d10[["StoreType"]], encode_ordinal1(d10[["StoreType"]]), useNA = "ifany")

table(d10[["StoreType"]],
      encode_ordinal1(d10[["StoreType"]], order = c(NA,"HighStore", "MediumStore", "SlowStore")),
      useNA = "ifany")

table(d10[["StoreType"]],
      encode_ordinal1(d10[["StoreType"]], order = c( "HighStore", "MediumStore","SlowStore" ,NA)),
      useNA = "ifany")

d10.1 <- d10
d10[["Store_encoded"]] <- encode_ordinal1(d10[["StoreType"]])
d10.1 <- d10.1 %>% select(-StoreType)
d10.1 %>% head(20)



```

```{r}
table(d10.1[["ProductType"]], encode_ordinal1(d10.1[["ProductType"]]), useNA = "ifany")

table(d10.1[["ProductType"]],
      encode_ordinal1(d10.1[["ProductType"]], order = c(NA,"HighProduct", "MediumProduct", "SlowProduct")),
      useNA = "ifany")

table(d10.1[["ProductType"]],
      encode_ordinal1(d10.1[["ProductType"]], order = c( "HighProduct", "MediumProduct","SlowProduct" ,NA)),
      useNA = "ifany")
d10.2 <- d10.1
d10.2[["Product_encoded"]] <- encode_ordinal1(d10.1[["ProductType"]])

d10.2 <- d10.2 %>% select(-ProductType)
d10.2 %>% head()
```

```{r}
linmod8 <- lm(SalesQuantity_x ~., d10.2)
linmod8 %>% summary()
```

No improvement could be made. Maximum R-square value was achieved with linmod4.

```{r}
linmod4 %>% summary
data1 <- d9.2
```

```{r}
data2 <- d10.2    #simplifying the variable names
``` 


```{r}
data1.2 <- data1
data1.2 <- data1.2 %>% mutate(Promotion = as.character(Promotion))
data1.2[data1.2$Promotion == "NoPromotion", "Promotion"] <- "0" 
data1.2[data1.2$Promotion == "PromotionSales", "Promotion"] <- "1" 
data1.2 <- data1.2 %>% mutate(Promotion = factor(Promotion))
```

```{r}
linmod9 <- lm(SalesQuantity_x ~., data= data1.2)
linmod9 %>% summary()
```
Replacing NoPromotion and PromotionSales with 0 and 1 also did not help. I am done. I think the best linear regression model is linmod4.

```{r}
linmod4 <- lm(SalesQuantity_x ~.+ StoreType:ProductType , data=data1)
linmod4 %>% summary()
```

```{r}
Effect(c("Promotion", "ProductType"), mod = linmod4, partial.residuals = TRUE) %>% plot()
```


```{r}
Effect(c("Promotion", "StoreType"), mod = linmod4, partial.residuals = TRUE) %>% plot()
```


```{r}
# data <- data %>% mutate(Promotion = as.character(Promotion))
# data[data$Promotion == "Promo1", "Promotion"] <- "PromotionSales"             #I will try one more time with un-transformed response variable.
# data[data$Promotion == "Promo2", "Promotion"] <- "PromotionSales" 
# data[data$Promotion == "Promo3", "Promotion"] <- "PromotionSales" 
# data[data$Promotion == "Promo4", "Promotion"] <- "PromotionSales"
# ```
# 
# ```{r}
# linmod_non_trans <- lm(SalesQuantity ~., data=data)
# linmod_non_trans %>% summary()     
```


```{r}
data1 %>%  
	group_by(ProductType,Promotion) %>%
	summarise(average_sales_of_product = mean(SalesQuantity_x))
```
I will try lasso regression.

```{r}
trainingrows <- (1:nrow(data1) %>% sample())[1:round(3/4*nrow(data1))]
training_data <- data1 %>% slice(trainingrows)
test_data <- data1 %>% slice(setdiff(1:nrow(data1),trainingrows))
```


```{r}
X.training <- training_data %>% model.matrix(SalesQuantity_x~.,.) #splitting training and test
X.test <- test_data %>% model.matrix(SalesQuantity_x~.,.)
y.training <- training_data$SalesQuantity_x
y.test <- test_data$SalesQuantity_x
```

```{r}
lasso <- cv.glmnet(X.training,y.training,alpha=1,nfolds=10) #finding lambda with cross validation, k=10
lasso$lambda.min
lasso.fit <- glmnet(X.training,y.training,alpha=1,lambda=lasso$lambda.min)
coef(lasso.fit) #to find non-zero coefficient estimates

predlasso <- predict(lasso.fit,X.test) #fitting model to test data
test.mse.with.lassofit=mean((y.test-predlasso)^2)
test.mse.with.lassofit
```

```{r}
linmod14 <- update(linmod4, . ~ . +ProductType:Promotion)   #I also added another interaction term between ProductType and Promotion.
linmod14 %>%   summary()
```


I am ending my model selection, I will continue with linmod14.

Now it is time to import and clean assignment4.1b. Then I will fit linmod14 to that data. This time, I am not going to use python for this, I will do data preparation on R and I'll make it quick since I don't have much time.
For loops take too much time when assigning the labels. I will proceed a bit manually in some steps.

```{r}
data3 <- read_csv("assignment4.1b.storesentered.csv")
data3 %>% summary()
data3 <- data3 %>% mutate(SalesQuantity_x = (SalesQuantity+1)^(1/3))
```

```{r}
data3[is.na(data3)]<-0
```

I was keeping the lists from part 1 that store which product/store code belongs to which class. I will make use of it. Also, to save time, I labeled Stores (also some of the FastProducts) in Excel. I will do the rest of labeling in R.

```{r}
data3[data3$ProductCode == "FastStore", "ProductCode"] <- "FastProduct"  #in excel, I accidently labeled some of the fast products as fast stores, I am fixing it.
```


For SlowProducts:

```{r}
data3[data3$ProductCode == "6", "ProductCode"] <- "SlowProduct"
data3[data3$ProductCode == "9", "ProductCode"] <- "SlowProduct" 
data3[data3$ProductCode == "10", "ProductCode"] <- "SlowProduct"
data3[data3$ProductCode == "11", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "12", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "13", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "14", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "16", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "19", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "21", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "22", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "23", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "24", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "27", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "29", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "30", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "31", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "32", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "35", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "36", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "45", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "48", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "49", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "51", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "52", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "53", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "55", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "56", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "57", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "63", "ProductCode"] <- "SlowProduct"
 data3[data3$ProductCode == "64", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "65", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "66", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "67", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "68", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "72", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "77", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "78", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "79", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "82", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "86", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "87", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "99", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "108", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "113", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "117", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "118", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "119", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "120", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "123", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "125", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "127", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "130", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "133", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "134", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "135", "ProductCode"] <- "SlowProduct"
 data3[data3$ProductCode == "136", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "151", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "152", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "153", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "154", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "159", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "160", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "161", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "163", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "164", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "165", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "182", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "183", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "191", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "192", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "200", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "226", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "227", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "228", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "229", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "231", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "235", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "235", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "236", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "248", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "260", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "262", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "265", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "268", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "269", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "270", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "271", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "272", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "273", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "274", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "276", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "277", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "278", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "279", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "285", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "286", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "289", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "291", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "298", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "309", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "310", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "311", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "314", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "315", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "316", "ProductCode"] <- "SlowProduct" 
 data3[data3$ProductCode == "317", "ProductCode"] <- "SlowProduct"
```

Yes.
It took me 10 mins to write them but it took only 10 seconds to run it. For loop would take 3 hours. Sometimes the simpler is the better.

Let's do it for MediumProducts:

```{r}
data3[data3$ProductCode == "8", "ProductCode"] <- "MediumProduct"
data3[data3$ProductCode == "15", "ProductCode"] <- "MediumProduct"
data3[data3$ProductCode == "17", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "18", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "20", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "25", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "28", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "33", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "34", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "37", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "38", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "39", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "40", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "41", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "42", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "43", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "44", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "46", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "47", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "50", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "54", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "58", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "59", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "61", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "62", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "73", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "74", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "75", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "76", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "80", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "81", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "83", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "84", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "85", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "88", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "89", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "91", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "92", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "93", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "94", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "95", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "96", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "97", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "98", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "102", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "103", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "105", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "104", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "107", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "114", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "115", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "122", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "126", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "128", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "129", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "131", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "132", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "138", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "140", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "146", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "147", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "150", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "155", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "156", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "157", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "158", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "173", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "175", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "176", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "180", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "181", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "193", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "198", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "201", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "202", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "203", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "204", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "223", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "224", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "225", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "230", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "232", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "233", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "234", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "240", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "253", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "256", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "257", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "275", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "280", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "281", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "282", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "282", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "283", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "284", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "287", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "288", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "290", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "292", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "293", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "297", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "301", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "302", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "303", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "304", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "305", "ProductCode"] <- "MediumProduct"
 data3[data3$ProductCode == "306", "ProductCode"] <- "MediumProduct"
```

Let's do it for Fast products too:

```{r}
data3[data3$ProductCode == "145", "ProductCode"] <- "FastProduct"
data3[data3$ProductCode == "148", "ProductCode"] <- "FastProduct"
data3[data3$ProductCode == "149", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "162", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "166", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "167", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "168", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "169", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "170", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "171", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "172", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "174", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "177", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "178", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "179", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "184", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "185", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "186", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "187", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "188", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "189", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "190", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "194", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "195", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "196", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "197", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "199", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "205", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "206", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "207", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "208", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "209", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "210", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "211", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "212", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "213", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "214", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "215", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "216", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "216", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "217", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "218", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "219", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "220", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "221", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "222", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "237", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "238", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "239", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "241", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "242", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "243", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "244", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "245", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "246", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "247", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "249", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "250", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "251", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "252", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "254", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "255", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "258", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "259", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "263", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "264", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "266", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "267", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "294", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "295", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "296", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "299", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "300", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "307", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "308", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "312", "ProductCode"] <- "FastProduct"
 data3[data3$ProductCode == "313", "ProductCode"] <- "FastProduct"
```

Done.
But should check.

```{r}
data3 %>% head()
```
I realized that date format is different than our training set. I will fix it later.

```{r}
data3 <- data3 %>% mutate(StoreCode = factor(StoreCode), ProductCode=factor(ProductCode)) %>% select(-SalesQuantity)
```

```{r}
data3 <- data3 %>% rename( StoreType = StoreCode, ProductType = ProductCode)
```

```{r}
data3 %>% summary()
```
There were some leakage. I need to fix them.

```{r}
data3 <- data3 %>% mutate(ProductType=as.character(ProductType))
```

```{r}
 data3[data3$ProductType == "154", "ProductType"] <- "SlowProduct"     #they are slow products
 data3[data3$ProductType == "159", "ProductType"] <- "SlowProduct"
 data3[data3$ProductType == "90", "ProductType"] <- "FastProduct"      #this one is fast
```

```{r}
data3 <- data3 %>% mutate(StoreType = factor(StoreType), ProductType=factor(ProductType)) #converting them back to factors
```

```{r}
data3 %>% summary()
```
160 is slow and 112 fast. 

```{r}
data3 <- data3 %>% mutate(ProductType=as.character(ProductType))
data3[data3$ProductType == "160", "ProductType"] <- "SlowProduct" 
data3[data3$ProductType == "112", "ProductType"] <- "FastProduct" 
```

```{r}
data3 <- data3 %>% mutate(StoreType = factor(StoreType), ProductType=factor(ProductType))
```

```{r}
data3 %>% summary()
```
Now the labels for stores and products are encoded. It is time to add promotion column.

```{r}
data4 <- data3 %>% mutate(Promotion="NoPromotion")
```

Recall our data was 'data1' when fitting the model on training data.

Now I am going to convert dates to YYYYMMDDD format and add promotion info.

```{r}
data5 <- data4
data5$Date <- as.Date(data5$Date, "%m/%d/%Y")
```

```{r}
data5[data5$Date >= "2015-09-01" & data5$Date <= "2015-09-06",]$Promotion <- 'PromotionSales'  #adding promotion info, I just looked promotion dates from the file name 'PromotionDates'.
data5[data5$Date >= "2015-11-20" & data5$Date <= "2015-11-27",]$Promotion <- 'PromotionSales'
```

```{r}
data5 <- data5 %>% mutate(Promotion = factor(Promotion))
#data5[273000:274000,]  #I just checked if everything is OK so far, and it seems it is.
```

Let us not forget to delete negative sales values. I should have done this in the beginning. Now I have to convert those salesquantity_x values back to their original values. Luckily the transformation is fairly simple.

```{r}
data6 <- data5 %>% mutate(SalesQuantity = (SalesQuantity_x^3)-1) %>% select(-SalesQuantity_x)
```

```{r}
data6$SalesQuantity[data6$SalesQuantity<0] <- 0 #indicating that no sales has been made at that date. 
```

```{r}
data6 <- data6 %>% mutate(SalesQuantity_x = (SalesQuantity+1)^(1/3)) %>% select(-SalesQuantity)   #transforming back
```

```{r}
data6 %>% head()
data6 %>% summary()
```
data6 will be our test data. I am going to fit the linmod14 on this test data and report the goodness of fit (in terms of R-square value and RSE/mean(SalesQuantity_x)).


```{r}
pred_linmod14 <- predict(linmod14)
test.mse.with.linmod14 <- mean(((data6$SalesQuantity_x) - pred_linmod14)^2)
test.mse.with.linmod14          #by the way, I don't know why it gives an error like Uninitialised column?. It seems everything is OK. please ignore it.
```
```{r}
linmod14 %>% summary()
```
I want to backup my data file in case something goes wrong. Maybe I fit some non-linear models in python using scikit learn, but I don't want to do it because of low interpretability.


```{r}
d9 <- d9 %>% mutate(Promotion = as.character(Promotion))
d9[d9$Promotion == "Promo1", "Promotion"] <- "PromotionSales"  
d9[d9$Promotion == "Promo2", "Promotion"] <- "PromotionSales"  
d9[d9$Promotion == "Promo3", "Promotion"] <- "PromotionSales"  
d9[d9$Promotion == "Promo4", "Promotion"] <- "PromotionSales" 
d9 <- d9 %>% mutate(Promotion = as.factor(Promotion))
d9 <- d9 %>% relocate(SalesQuantity_x) %>% relocate(Promotion) %>% relocate(ProductType) %>% relocate(StoreType) %>% relocate(Date) #I just wanted to make the order same as the test set.
```


```{r}
write.csv(d9,"C:\\users\\asus\\Desktop\\training.csv", row.names = FALSE)
write.csv(data6,"C:\\users\\asus\\Desktop\\test.csv", row.names = FALSE)
```

Alright. We have our training and test set. This is nice. Variable names for dataframes started to become a mess. I needed to simplify them. Let me look at a couple of box-plots and other plots.

```{r}
d_training <- read.csv("training.csv")
d_test <- read.csv("test.csv")
```


```{r}
d_training %>%  
	group_by(Date) %>%
	summarise(average_sales_of_product = mean(SalesQuantity_x))
```

```{r}
d_timeseries <- d_training %>% select(-StoreType) %>% select(-ProductType) %>% select(-Promotion) %>% mutate(Date = as.Date(Date))
ts1 <- ts(d_timeseries,frequency = 52)
plot.ts(ts1)

(time_plot <- ggplot(d_timeseries, aes(x = Date, y = SalesQuantity_x)) +
	geom_line() +
	scale_x_date(date_labels = "%W", date_breaks = "1 week") +
	theme_classic())
# 
# (decomp_2 <- ggplot(d_timeseries, aes(x = Date, y = SalesQuantity_x)) +
# 	geom_line() +
# 	geom_smooth(method = "loess", se = FALSE, span = 0.6) +
# 	theme_classic())
```

I have tried to identify if there is any seasonal pattern or trend by looking at the time series plot. I couldn't extract any information.

I want to open a new .rmd file, this one starts to become a mess. Please follow from part 3.




